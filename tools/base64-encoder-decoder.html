<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Encodeur/D√©codeur Base64</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg-color: #f3f4f7;
        --text-color: #000;
        --panel-bg: #fff;
        --panel-border: #d0d7de;
        --textarea-bg: #fafafa;
        --btn-bg: #0a66c2;
        --btn-text: #fff;
        --muted: #6b7280;
        --danger: #b91c1c;
        --success: #166534;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        --accent: #0a66c2;
      }
      body.dark {
        --bg-color: #121212;
        --text-color: #f3f3f3;
        --panel-bg: #1e1e1e;
        --panel-border: #333;
        --textarea-bg: #2a2a2a;
        --muted: #9aa0a6;
        --danger: #ef4444;
        --success: #22c55e;
        --shadow: 0 2px 16px rgba(0, 0, 0, 0.35);
        --accent: #4ea0ff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        transition: background 0.25s ease, color 0.25s ease;
      }

      .top-banner {
        background: #0a66c2;
        color: #fff;
        padding: 12px 24px;
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 15px;
        font-weight: 600;
      }
      .top-banner a {
        color: #fff;
        text-decoration: none;
        font-weight: 700;
      }

      header {
        background: #0a66c2;
        color: #fff;
        padding: 18px 28px;
        font-size: 22px;
        font-weight: 700;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .theme-toggle {
        background: none;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        transition: transform 0.15s;
      }
      .theme-toggle:hover {
        transform: scale(1.08);
      }

      /* Layout principal √† deux colonnes (70% / 30%) */
      .wrap {
        display: grid;
        grid-template-columns: 70% 30%;
        gap: 24px;
        padding: 24px;
        align-items: start;
      }
      @media (max-width: 1000px) {
        .wrap {
          grid-template-columns: 1fr;
        }
        aside {
          order: 2;
        }
      }

      main,
      aside {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        box-shadow: var(--shadow);
      }

      /* S√©paration visuelle claire c√¥t√© droit */
      aside {
        border-left: 3px solid var(--panel-border);
      }

      main {
        padding: 24px;
      }
      aside {
        display: flex;
        flex-direction: column;
        min-height: 60vh;
      }

      /* En-t√™te sticky du panneau historique */
      .aside-head {
        position: sticky;
        top: 0;
        z-index: 1;
        background: var(--panel-bg);
        padding: 12px 14px;
        border-bottom: 1px solid var(--panel-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
      }
      .aside-title {
        font-weight: 800;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .aside-tools {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn-ghost {
        background: transparent;
        color: var(--text-color);
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
      }
      .btn-ghost.danger {
        color: var(--danger);
        border-color: var(--danger);
      }

      /* Liste historique scrollable */
      .history-list {
        padding: 12px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
      }

      textarea {
        width: 100%;
        height: 160px;
        padding: 12px;
        font-size: 14px;
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        background: var(--textarea-bg);
        color: var(--text-color);
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas,
          "Liberation Mono", monospace;
      }
      label {
        display: block;
        font-weight: 700;
        margin: 12px 0 8px;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      button {
        padding: 10px 14px;
        background: var(--btn-bg);
        color: var(--btn-text);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: opacity 0.2s, transform 0.1s;
      }
      button:hover {
        opacity: 0.95;
        transform: translateY(-1px);
      }
      .btn-outline {
        background: transparent;
        color: var(--text-color);
        border: 1px solid var(--panel-border);
      }
      #message {
        min-height: 1.2em;
        margin-top: 10px;
        font-size: 14px;
      }

      /* Items d'historique */
      .history-item {
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        background: var(--textarea-bg);
        padding: 10px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 6px 10px;
        max-height: 300px;
        transition: max-height 0.25s, opacity 0.2s, transform 0.2s, margin 0.25s,
          padding 0.25s, border-width 0.25s;
      }
      .history-item.removing {
        opacity: 0;
        transform: translateY(-6px);
        max-height: 0;
        margin: 0;
        padding: 0;
        border-width: 0;
      }
      .history-meta {
        grid-column: 1 / -1;
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 12px;
        color: var(--muted);
      }
      .chip {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--panel-border);
        background: var(--panel-bg);
      }
      .muted {
        color: var(--muted);
      }
      .history-line {
        grid-column: 1 / -1;
        font-size: 13px;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        padding: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }
      .history-actions {
        grid-column: 2 / 3;
        display: flex;
        gap: 6px;
      }
      .btn-ghost.small {
        padding: 6px 8px;
        font-size: 12px;
      }

      /* Modals */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .modal {
        background: var(--panel-bg);
        color: var(--text-color);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        width: min(920px, 92vw);
        max-height: 88vh;
        overflow: auto;
        padding: 16px;
      }
      .modal header {
        padding: 0 0 10px;
        border-bottom: 1px solid var(--panel-border);
        font-size: 18px;
      }
      .modal pre {
        background: var(--textarea-bg);
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        padding: 12px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas,
          "Liberation Mono", monospace;
        font-size: 13px;
      }
      .modal .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="top-banner">
      üîô <a href="../index.html">Retour au portail</a>
    </div>

    <header>
      üîê Encodeur/D√©codeur Base64
      <button
        class="theme-toggle"
        onclick="toggleTheme()"
        title="Changer le th√®me"
      >
        üåô
      </button>
    </header>

    <div class="wrap">
      <!-- Colonne principale (70%) -->
      <main>
        <section>
          <label for="input">üî§ Texte √† traiter :</label>
          <textarea
            id="input"
            placeholder="Entrez ici le texte brut ou en base64..."
          ></textarea>
        </section>

        <div class="actions">
          <button onclick="encodeBase64()">üîº Encoder</button>
          <button onclick="decodeBase64()">üîΩ D√©coder</button>
          <button onclick="copyOutput()">üìã Copier le r√©sultat</button>
          <button class="btn-outline" onclick="clearFields()">
            üßπ Effacer
          </button>
        </div>

        <div id="message"></div>

        <section>
          <label for="output">üìÑ R√©sultat :</label>
          <textarea id="output" readonly></textarea>
        </section>
      </main>

      <!-- Panneau historique fixe (30%) -->
      <aside>
        <div class="aside-head">
          <div class="aside-title">üïò Historique</div>
          <div class="aside-tools">
            <button
              class="btn-ghost"
              onclick="openStateModal()"
              title="Voir l'√©tat JSON"
            >
              üîß Voir √©tat
            </button>
            <button
              class="btn-ghost danger"
              onclick="clearHistory()"
              title="Tout effacer"
            >
              üóë Tout effacer
            </button>
          </div>
        </div>
        <div id="historyList" class="history-list" aria-live="polite"></div>
      </aside>
    </div>

    <!-- Modal d√©tail d'entr√©e -->
    <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
      <div class="modal">
        <header><strong id="modalTitle">D√©tail</strong></header>
        <section>
          <p class="muted"><span id="modalMeta"></span></p>
          <label class="muted">Texte original</label>
          <pre id="modalOriginal"></pre>
          <label class="muted">R√©sultat</label>
          <pre id="modalResult"></pre>
        </section>
        <div class="modal-actions">
          <button class="btn-ghost" onclick="closeModal()">Fermer</button>
          <button onclick="copyModal()">üìã Copier le r√©sultat</button>
        </div>
      </div>
    </div>

    <!-- Modal debug √©tat -->
    <div id="stateBackdrop" class="modal-backdrop" aria-hidden="true">
      <div class="modal">
        <header>
          <strong>√âtat localStorage (base64-encoder-decoder)</strong>
        </header>
        <section><pre id="stateJson"></pre></section>
        <div class="modal-actions">
          <button class="btn-ghost" onclick="closeStateModal()">Fermer</button>
          <button onclick="copyState()">üìã Copier JSON</button>
        </div>
      </div>
    </div>

    <script>
      // ---------- Stockage unifi√© ----------
      const LS_KEY = "base64-encoder-decoder";
      function loadState() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (!raw) return { theme: "light", history: [] };
          const parsed = JSON.parse(raw);
          return {
            theme: parsed?.theme === "dark" ? "dark" : "light",
            history: Array.isArray(parsed?.history) ? parsed.history : [],
          };
        } catch {
          return { theme: "light", history: [] };
        }
      }
      function saveState(state) {
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      }

      // ---------- Init ----------
      window.addEventListener("load", () => {
        const state = loadState();
        if (state.theme === "dark") {
          document.body.classList.add("dark");
          document.querySelector(".theme-toggle").textContent = "üåû";
        }
        renderHistory(state.history);
      });

      // ---------- Th√®me ----------
      function toggleTheme() {
        const state = loadState();
        const isDark = !(state.theme === "dark");
        state.theme = isDark ? "dark" : "light";
        saveState(state);
        document.body.classList.toggle("dark", isDark);
        document.querySelector(".theme-toggle").textContent = isDark
          ? "üåû"
          : "üåô";
      }

      // ---------- Helpers ----------
      function showMessage(msg, isError = true) {
        const el = document.getElementById("message");
        el.textContent = msg;
        el.style.color = isError ? "var(--danger)" : "var(--success)";
      }
      function clearFields() {
        document.getElementById("input").value = "";
        document.getElementById("output").value = "";
        showMessage("üßπ Champs effac√©s", false);
      }
      function nowStamp() {
        const d = new Date(),
          p = (n) => String(n).padStart(2, "0");
        return `${p(d.getDate())}/${p(d.getMonth() + 1)}/${d.getFullYear()} ${p(
          d.getHours()
        )}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
      }

      // ---------- Base64 (UTF-8 safe) ----------
      function utf8ToB64(str) {
        const bytes = new TextEncoder().encode(str);
        let bin = "";
        for (let i = 0; i < bytes.length; i++)
          bin += String.fromCharCode(bytes[i]);
        return btoa(bin);
      }
      function b64ToUtf8(b64) {
        const bin = atob(b64);
        const bytes = Uint8Array.from(bin, (c) => c.charCodeAt(0));
        return new TextDecoder().decode(bytes);
      }

      // ---------- Actions principales ----------
      function encodeBase64() {
        const input = document.getElementById("input").value;
        if (!input) return showMessage("‚ùå Entrez un texte avant d'encoder.");
        try {
          const encoded = utf8ToB64(input);
          document.getElementById("output").value = encoded;
          showMessage("‚úÖ Texte encod√© avec succ√®s", false);
          pushHistory({
            type: "encode",
            original: input,
            result: encoded,
            ts: nowStamp(),
          });
        } catch {
          showMessage("‚ùå Erreur : texte invalide pour l'encodage.");
        }
      }
      function decodeBase64() {
        const input = document.getElementById("input").value;
        if (!input)
          return showMessage("‚ùå Entrez une cha√Æne Base64 √† d√©coder.");
        try {
          const decoded = b64ToUtf8(input);
          document.getElementById("output").value = decoded;
          showMessage("‚úÖ Texte d√©cod√© avec succ√®s", false);
          pushHistory({
            type: "decode",
            original: input,
            result: decoded,
            ts: nowStamp(),
          });
        } catch {
          showMessage("‚ùå Erreur : cha√Æne Base64 invalide.");
        }
      }
      function copyOutput() {
        const out = document.getElementById("output").value;
        if (!out) return showMessage("‚ùå Aucun contenu √† copier.");
        navigator.clipboard
          .writeText(out)
          .then(() =>
            showMessage("‚úÖ R√©sultat copi√© dans le presse-papiers", false)
          );
      }

      // ---------- Historique (MRU + suppression) ----------
      function entriesEqual(a, b) {
        return (
          a.type === b.type &&
          a.original === b.original &&
          a.result === b.result
        );
      }
      function pushHistory(entry) {
        const state = loadState();
        const idx = state.history.findIndex((e) => entriesEqual(e, entry));
        if (idx !== -1) state.history.splice(idx, 1); // MRU: retire l'existant
        state.history.unshift(entry);
        if (state.history.length > 200)
          state.history = state.history.slice(0, 200);
        saveState(state);
        renderHistory(state.history);
      }
      function clearHistory() {
        const state = loadState();
        state.history = [];
        saveState(state);
        renderHistory(state.history);
        showMessage("üóë Historique effac√©", false);
      }
      function deleteEntry(trueIndex, node) {
        const state = loadState();
        if (trueIndex < 0 || trueIndex >= state.history.length) return;
        state.history.splice(trueIndex, 1);
        saveState(state);
        node.classList.add("removing");
        node.addEventListener(
          "transitionend",
          () => {
            renderHistory(state.history);
            showMessage("üóëÔ∏è Entr√©e supprim√©e", false);
          },
          { once: true }
        );
      }
      function renderHistory(items) {
        const list = document.getElementById("historyList");
        list.innerHTML = "";
        if (!items.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.style.padding = "8px 6px";
          empty.textContent = "Aucune entr√©e d'historique pour le moment.";
          list.appendChild(empty);
          return;
        }
        items.forEach((it, idx) => {
          const item = document.createElement("div");
          item.className = "history-item";
          item.dataset.trueIndex = String(idx);

          const meta = document.createElement("div");
          meta.className = "history-meta";
          const icon = it.type === "encode" ? "üîº" : "üîΩ";
          const label = it.type === "encode" ? "Encodage" : "D√©codage";
          meta.innerHTML = `<span class="chip">${icon} ${label}</span><span class="muted">${
            it.ts || ""
          }</span>`;
          item.appendChild(meta);

          const l1 = document.createElement("div");
          l1.className = "history-line";
          l1.title = "Texte original";
          l1.textContent = it.original ?? "";
          item.appendChild(l1);

          const l2 = document.createElement("div");
          l2.className = "history-line";
          l2.title = "R√©sultat";
          l2.textContent = it.result ?? "";
          item.appendChild(l2);

          const actions = document.createElement("div");
          actions.className = "history-actions";

          const btnEdit = document.createElement("button");
          btnEdit.className = "btn-ghost small";
          btnEdit.title = "R√©injecter le texte original √† gauche";
          btnEdit.textContent = "‚úèÔ∏è";
          btnEdit.addEventListener("click", () => {
            document.getElementById("input").value = it.original ?? "";
            showMessage(
              "‚úèÔ∏è Texte original r√©inject√© dans le champ d‚Äôentr√©e",
              false
            );
            window.scrollTo({ top: 0, behavior: "smooth" });
          });

          const btnView = document.createElement("button");
          btnView.className = "btn-ghost small";
          btnView.title = "Voir en plein √©cran";
          btnView.textContent = "üîç";
          btnView.addEventListener("click", () => openModal(it));

          const btnDel = document.createElement("button");
          btnDel.className = "btn-ghost small danger";
          btnDel.title = "Supprimer cette entr√©e";
          btnDel.textContent = "üóëÔ∏è";
          btnDel.addEventListener("click", () => deleteEntry(idx, item));

          actions.append(btnEdit, btnView, btnDel);
          item.appendChild(actions);

          list.appendChild(item);
        });
      }

      // ---------- Modal D√©tail ----------
      function openModal(entry) {
        document.getElementById("modalTitle").textContent =
          entry.type === "encode" ? "üîº Encodage" : "üîΩ D√©codage";
        document.getElementById("modalMeta").textContent = entry.ts || "";
        document.getElementById("modalOriginal").textContent =
          entry.original ?? "";
        document.getElementById("modalResult").textContent = entry.result ?? "";
        const back = document.getElementById("modalBackdrop");
        back.style.display = "flex";
        back.setAttribute("aria-hidden", "false");
        back.addEventListener("click", modalBackdropCloser);
        back
          .querySelector(".modal")
          .addEventListener("click", (ev) => ev.stopPropagation(), {
            once: true,
          });
        document.addEventListener("keydown", modalEscCloser);
      }
      function closeModal() {
        const back = document.getElementById("modalBackdrop");
        back.style.display = "none";
        back.setAttribute("aria-hidden", "true");
        back.removeEventListener("click", modalBackdropCloser);
        document.removeEventListener("keydown", modalEscCloser);
      }
      function modalBackdropCloser(e) {
        if (e.target.id === "modalBackdrop") closeModal();
      }
      function modalEscCloser(e) {
        if (e.key === "Escape") closeModal();
      }
      function copyModal() {
        const content =
          document.getElementById("modalResult").textContent || "";
        if (!content) return showMessage("‚ùå Aucun contenu √† copier (modal).");
        navigator.clipboard
          .writeText(content)
          .then(() =>
            showMessage(
              "‚úÖ R√©sultat (modal) copi√© dans le presse-papiers",
              false
            )
          );
      }

      // ---------- Modal √âtat (debug) ----------
      function openStateModal() {
        document.getElementById("stateJson").textContent = JSON.stringify(
          loadState(),
          null,
          2
        );
        const back = document.getElementById("stateBackdrop");
        back.style.display = "flex";
        back.setAttribute("aria-hidden", "false");
        back.addEventListener("click", stateBackdropCloser);
        back
          .querySelector(".modal")
          .addEventListener("click", (ev) => ev.stopPropagation(), {
            once: true,
          });
        document.addEventListener("keydown", stateEscCloser);
      }
      function closeStateModal() {
        const back = document.getElementById("stateBackdrop");
        back.style.display = "none";
        back.setAttribute("aria-hidden", "true");
        back.removeEventListener("click", stateBackdropCloser);
        document.removeEventListener("keydown", stateEscCloser);
      }
      function stateBackdropCloser(e) {
        if (e.target.id === "stateBackdrop") closeStateModal();
      }
      function stateEscCloser(e) {
        if (e.key === "Escape") closeStateModal();
      }
      function copyState() {
        const content = document.getElementById("stateJson").textContent || "";
        if (!content) return showMessage("‚ùå Rien √† copier (√©tat).");
        navigator.clipboard
          .writeText(content)
          .then(() =>
            showMessage("‚úÖ √âtat copi√© dans le presse-papiers", false)
          );
      }
    </script>
  </body>
</html>
